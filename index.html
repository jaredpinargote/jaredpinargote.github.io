<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keywords Prediction</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .keywords-panel {
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        #graph {
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .prediction {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .prediction:hover {
            background: #f0f0f0;
        }
        .current-keyword {
            display: inline-block;
            margin: 5px;
            padding: 5px 10px;
            background: #e0e0e0;
            border-radius: 15px;
        }
        .delete-btn {
            margin-left: 5px;
            cursor: pointer;
            color: red;
        }
        #session-controls {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Keywords Prediction App</h1>

    <div id="session-controls">
        <button onclick="newSession()">New Session</button>
        <button onclick="saveSession()">Save Session</button>
        <button onclick="exportData()">Export</button>
        <input type="file" id="import-file" style="display: none" onchange="importData(event)">
        <button onclick="document.getElementById('import-file').click()">Import</button>
    </div>

    <div class="container">
        <div class="keywords-panel">
            <h3>Current Keywords</h3>
            <div>
                <input type="text" id="keyword-input" placeholder="Enter a keyword">
                <button onclick="addKeyword()">Add</button>
            </div>
            <div id="current-keywords"></div>

            <h3>Predictions</h3>
            <div id="predictions"></div>
        </div>

        <div id="graph"></div>
    </div>

    <script>
        // Data structures
        let keywords = [];
        let associations = {};

        // Initialize Cytoscape
        const cy = cytoscape({
            container: document.getElementById('graph'),
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'background-color': '#666',
                        'width': 30,
                        'height': 30
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#999'
                    }
                },
                {
                    selector: '.current',
                    style: {
                        'background-color': '#2196F3'
                    }
                },
                {
                    selector: '.predicted',
                    style: {
                        'background-color': '#4CAF50'
                    }
                }
            ]
        });

        // Current session
        let currentKeywords = [];

        function addKeyword() {
            const input = document.getElementById('keyword-input');
            const keyword = input.value.trim().toLowerCase();

            if (keyword && !currentKeywords.includes(keyword)) {
                currentKeywords.push(keyword);
                if (!keywords.includes(keyword)) {
                    keywords.push(keyword);
                }
                updateUI();
                predictNextKeywords();
            }

            input.value = '';
        }

        function deleteKeyword(index) {
            currentKeywords.splice(index, 1);
            updateUI();
            predictNextKeywords();
        }

        function updateUI() {
            // Update current keywords display
            const container = document.getElementById('current-keywords');
            container.innerHTML = currentKeywords.map((keyword, index) => `
                <span class="current-keyword">
                    ${keyword}
                    <span class="delete-btn" onclick="deleteKeyword(${index})">Ã—</span>
                </span>
            `).join('');

            // Update graph
            updateGraph();
        }

        function updateGraph() {
            cy.elements().remove();

            // Add nodes
            keywords.forEach((keyword, index) => {
                cy.add({
                    group: 'nodes',
                    data: {
                        id: String(index),
                        label: keyword
                    },
                    classes: currentKeywords.includes(keyword) ? 'current' : ''
                });
            });

            // Add edges
            Object.entries(associations).forEach(([key, value]) => {
                const [id1, id2] = key.split('-');
                cy.add({
                    group: 'edges',
                    data: {
                        source: id1,
                        target: id2
                    }
                });
            });

            // Layout
            cy.layout({ name: 'circle' }).run();
        }

        function predictNextKeywords() {
            if (currentKeywords.length === 0) {
                document.getElementById('predictions').innerHTML = '';
                return;
            }

            // Get current keyword indices
            const currentIndices = currentKeywords.map(k => keywords.indexOf(k));

            // Find candidate keywords
            const candidates = {};

            Object.entries(associations).forEach(([key, [id1, id2, distance]]) => {
                const [idx1, idx2] = key.split('-').map(Number);

                if (currentIndices.includes(idx1) && !currentIndices.includes(idx2)) {
                    candidates[idx2] = candidates[idx2] || [];
                    candidates[idx2].push(distance);
                } else if (currentIndices.includes(idx2) && !currentIndices.includes(idx1)) {
                    candidates[idx1] = candidates[idx1] || [];
                    candidates[idx1].push(distance);
                }
            });

            // Calculate scores
            const scores = Object.entries(candidates).map(([idx, distances]) => {
                const avgDistance = distances.reduce((a, b) => a + b, 0) / distances.length;
                return {
                    keyword: keywords[idx],
                    score: 1 / (1 + avgDistance)
                };
            });

            // Sort and display predictions
            scores.sort((a, b) => b.score - a.score);

            document.getElementById('predictions').innerHTML = scores
                .slice(0, 3)
                .map(({keyword, score}) => `
                    <div class="prediction" onclick="addPrediction('${keyword}')">
                        ${keyword} (${score.toFixed(2)})
                    </div>
                `).join('');
        }

        function addPrediction(keyword) {
            if (!currentKeywords.includes(keyword)) {
                currentKeywords.push(keyword);
                updateUI();
                predictNextKeywords();
            }
        }

        function newSession() {
            currentKeywords = [];
            updateUI();
            predictNextKeywords();
        }

        function saveSession() {
            // Create associations for current session
            for (let i = 0; i < currentKeywords.length; i++) {
                for (let j = i + 1; j < currentKeywords.length; j++) {
                    const idx1 = keywords.indexOf(currentKeywords[i]);
                    const idx2 = keywords.indexOf(currentKeywords[j]);
                    const distance = j - i - 1;

                    const key = `${Math.min(idx1, idx2)}-${Math.max(idx1, idx2)}`;
                    associations[key] = [idx1, idx2, distance];
                }
            }

            // Save to localStorage
            localStorage.setItem('keywords', JSON.stringify(keywords));
            localStorage.setItem('associations', JSON.stringify(associations));

            alert('Session saved!');
        }

        function exportData() {
            const data = {
                keywords,
                associations
            };

            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'keywords-data.json';
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                keywords = data.keywords;
                associations = data.associations;

                localStorage.setItem('keywords', JSON.stringify(keywords));
                localStorage.setItem('associations', JSON.stringify(associations));

                updateUI();
                predictNextKeywords();
            };

            reader.readAsText(file);
        }

        // Load data from localStorage on startup
        const savedKeywords = localStorage.getItem('keywords');
        const savedAssociations = localStorage.getItem('associations');

        if (savedKeywords && savedAssociations) {
            keywords = JSON.parse(savedKeywords);
            associations = JSON.parse(savedAssociations);
            updateUI();
        }
    </script>
</body>
</html>